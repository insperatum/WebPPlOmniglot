var Canvas = require('canvas');
var fs = require('fs');
var Tensor = require('adnn/tensor');

var drawStrokes = function(strokes) {
  var canvas = new Canvas(105, 105);
  var ctx=canvas.getContext("2d");
  ctx.fillStyle = 'white';
	ctx.fillRect(0, 0, 105, 105);
	ctx.lineWidth = 5;
	for(i in strokes) {
	  var s = strokes[i]
	  ctx.beginPath();
	  ctx.moveTo(105*s[0][0], 105*s[0][1]);
	  for(var j=1; j<s.length; j++) {
	    ctx.lineTo(105*s[j][0], 105*s[j][1]);
	  }
	  ctx.stroke();
	}
	return {canvas:canvas, context:ctx}
}

var saveStrokes = function(strokes, filename) {
  fs.writeFileSync(filename, drawStrokes(strokes).canvas.toBuffer());
}

var getImageData = function(strokes) {
  var imageData = drawStrokes(strokes).context.getImageData(0, 0, 105, 105);
  var data = new Tensor([105, 105]);
  for(var x=0; x<105; x++) {
    for(var y=0; y<105; y++) {
      data.set([x, y], 1 - (imageData.data[y*105*4 + x*4] / 255.))
    }
  }
  return data
}

module.exports = {getImageData:getImageData, saveStrokes:saveStrokes}
